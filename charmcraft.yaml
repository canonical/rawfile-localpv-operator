# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

name: rawfile-localpv
title: Rawfile LocalPV
summary: Subordinate charm for deploying CSI plugin for OpenEBS Rawfile LocalPV.
description: |
  This charm deploys a Container Storage Interface (CSI) plugin,
  enabling a Canonical Kubernetes cluster to use rawfile-localpv
  as a storage backend.

type: charm
subordinate: true
parts:
  charm:
    source: .
    plugin: uv
    build-snaps:
      - astral-uv
    override-build: |
      craftctl default
  manifests:
    plugin: dump
    source: .
    stage:
      - upstream/**

platforms:
  ubuntu-22.04-amd64:
    build-on:
      - ubuntu@22.04:amd64
    build-for:
      - ubuntu@22.04:amd64
  ubuntu-22.04-arm64:
    build-on:
      - ubuntu@22.04:arm64
    build-for:
      - ubuntu@22.04:arm64

  ubuntu-24.04-amd64:
    build-on:
      - ubuntu@24.04:amd64
    build-for:
      - ubuntu@24.04:amd64
  ubuntu-24.04-arm64:
    build-on:
      - ubuntu@24.04:arm64
    build-for:
      - ubuntu@24.04:arm64

config:
  options:
    csi-driver-formatter:
      type: string
      description: |
        Specifies a formatter for the CSI driver name. This should be unique
        if deploying multiple instances. Valid placeholders:
          {app}  - The Juju application name.
          {name} - The original CSI driver name: 'rawfile.csi.openebs.io'
        Example: "{app}-{name}"
      default: "{app}-{name}"
    create-namespace:
      type: boolean
      default: false
      description: |
        Allow the charm to create the configured namespace if it does not
        exist.
        Note: The charm does not manage the lifecycle of the namespace and
          will not remove it if the charm is removed from the model.
    namespace:
      type: string
      default: default
      description: |
        The Kubernetes namespace in which to install rawfile-localpv resources,
        including Deployments, DaemonSets, and other namespaced resources.

        If unspecified, "default" is used.

        NOTE: This can only be set at deployment time, as some Kubernetes
        resource attributes are immutable after creation.
    node-selector:
      type: string
      description: |
        Specifies which nodes this operator targets for rawfile-localpv.
        Declare node labels in key=value format, separated by spaces.
        If no selector is set, a random node in the cluster may be
        assigned.
    node-storage-path:
      type: string
      default: "/var/csi/rawfile"
      description: |
        The path on each node where rawfile-localpv will store its data.
    rbac-name-formatter:
      type: string
      description: |
        Specifies a formatter for cluster-wide RBAC resource names.
        Valid placeholders:
          {app}  - The Juju application name.
          {name} - The original resource name.
        Example: "{app}-{name}"
      default: "{app}-{name}"
    storage-class-name:
      type: string
      description: |
        The name of the StorageClass to create by default and assign to the
        provider.
    storage-class-reclaim-policy:
      type: string
      description: |
        The reclaim policy to use for the StorageClass.
    image-registry:
      type: string
      description: |
        Image registry for all rawfile-localpv CSI container images.

        This value replaces the image registry in image URLs from the release
        manifests. For example, an image URL like
        `ghcr.io/canonical/rawfile-localpv:0.8.2` becomes
        `myregistry.com/canonical/rawfile-localpv:0.8.2` if set to
        `myregistry.com`.

        Example:
          juju config rawfile-localpv image-registry="myregistry.com"
    release:
      type: string
      default: "8.0.2"
      description: |
        The version of rawfile-localpv to deploy.

        Example:
          juju config rawfile-localpv release='8.0.2'

        A list of supported versions is available via:
          juju run rawfile-localpv/leader list-versions

        To reset to the latest version supported by the charm:
          juju config rawfile-localpv --reset release

        The currently deployed release can be viewed with:
          juju status rawfile-localpv

actions:
  list-versions:
    description: List versions supported by this charm
  list-resources:
    description: List Resources of configured version
    params:
      resources:
        type: string
        default: ""
        description: |
          Space separated list of kubernetes resource types to filter list result
  scrub-resources:
    description: Remove deployments other than the current one
    params:
      resources:
        type: string
        default: ""
        description: |
          Space separated list of kubernetes resource types to filter scrubbing
  sync-resources:
    description: |
      Add kubernetes resources which should be created by this charm which aren't
      present within the cluster.
    params:
      resources:
        type: string
        default: ""
        description: |
          Space separated list of kubernetes resource types
          to use a filter during the sync. This helps limit
          which missing resources are applied.

requires:
  kubernetes:
    interface: juju-info
    scope: container
